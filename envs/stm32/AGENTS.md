
# STM32 嵌入式工程

本仓库是一个 **STM32 Cortex-M 系列 MCU 的嵌入式工程**，主要特征如下：

- 目标平台：STM32（Cortex-M）
- 语言：C 
- 工程类型：
  - 裸机 或
  - FreeRTOS
- 构建方式：基于标准交叉编译工具链

##  工程目录结构（语义约束）

AI 必须基于以下 **语义稳定的工程结构** 来理解和建议代码：

```

project/
├── CMakeLists.txt          # 构建入口
├── cmake/                  # 构建辅助模块
├── linker/                 # 链接脚本 (*.ld)
├── include/                # 对外头文件
│   ├── bsp/
│   └── app/
├── src/
│   ├── main.c
│   ├── bsp/                # 板级支持层
│   ├── drivers/            # 驱动层
│   └── app/                # 应用逻辑
├── freertos/               # FreeRTOS（如使用）
└── docs/
└── arch.md             # 架构与系统约束说明

```

约束：

- BSP / Driver / App 层职责必须清晰
- AI 不得跨层混写逻辑
- 不得假设不存在的目录或文件



## 工具链与代码生成假设
- 所有 STM32 工程统一使用 STM32 HAL 库
- 外设访问必须通过 HAL API
- 不直接操作外设寄存器（除非用户明确允许）
- LL 库不作为默认选项

### 工具链假设（用于语义理解）

- 使用标准 ARM Cortex-M 交叉编译工具链
- 目标为 `arm-none-eabi` 架构
- 构建系统为 CMake 或 Makefile

AI 输出的代码必须满足：

- 可被标准 Cortex-M GCC 工具链编译
- 不依赖主机系统特性
- 不包含平台相关的系统调用

### 嵌入式编码强约束

AI **必须遵守以下嵌入式工程约束**：

- ❌ 不绕过 HAL 直接访问外设寄存器（除非明确要求）
- ❌ 不使用动态内存（`malloc / free / new / delete`），除非明确说明
- ❌ 不在中断中调用阻塞函数
- ❌ 不在 ISR 中调用非 ISR-safe 的 RTOS API
- ❌ 不假设存在文件系统、进程或操作系统服务
- ❌ 不修改或重写链接脚本（`*.ld`），除非明确要求

推荐实践：

- 外设 I/O 优先使用 DMA + 缓冲区
- 初始化与运行期逻辑分离
- 明确区分：
  - 中断上下文
  - 线程 / 主循环上下文

##  主机环境与运行环境假设

AI 必须遵循以下原则：

- STM32 工程核心代码 **与开发主机环境无关**
- 不应假设：
  - 特定操作系统
  - 特定 IDE
  - 特定调试硬件或连接方式
- 所有建议应聚焦于：
  - MCU 端代码
  - 构建与链接语义
  - 运行时行为分析

## AI 行为边界

### 允许的行为

AI 可以：

- 生成外设初始化与 BSP 骨架代码
- 生成驱动接口定义
- Review 代码中的：
  - 并发问题
  - ISR / RTOS 使用问题
  - 栈与内存风险
- 分析：
  - 编译错误
  - 链接错误
  - HardFault / UsageFault
  - `.map` 文件

### 禁止的行为

AI 不得：

- 自动重构工程结构
- 引入新的第三方库或中间件
- 随意假设 MCU 型号、外设或引脚配置
- 输出“可直接执行”的硬件操作指令
- 不建议将 HAL 初始化代码替换为寄存器级实现以“优化性能”

## STM32 工程通用事实（默认前提）

在未被明确推翻前，AI 应默认：

- MCU 为 STM32 Cortex-M 系列
- 外设访问通过 HAL / BSP 封装
- 资源受限，应关注：
  - 栈大小
  - SRAM / Flash 占用
- 若使用 FreeRTOS：
  - 中断优先级遵循 `configMAX_SYSCALL_INTERRUPT_PRIORITY`

## 第三方 / 开源库使用规则（如工程中已存在）

- 若工程中已包含第三方库，AI 不得假设其用途，必须先进行语义归类：
  - Driver 类（器件/外设驱动）
  - Middleware 类（协议栈/文件系统等）
  - Algorithm 类（与硬件无关的算法）
  - Framework 类（子系统级框架）

- 在未完成归类前：
  - 不得直接在 app/ 中使用该库 API
  - 不得扩散其头文件到 include/app/

- 默认不修改第三方库源码；
  若必须修改，需说明原因与影响范围。


## 外部资料使用原则

- 仅在明确需要时引用：
  - STM32 Reference Manual
  - Datasheet
- 引用时需说明：
  - 具体章节
  - 引用目的
- 不进行无目的的大规模资料加载

## 规则例外的裁决来源

- 以下情况必须由“架构裁决”明确允许：
  - App 层直接使用第三方库 API
  - 驱动层引入非 HAL 抽象
  - 打破既有 BSP / Driver / App 边界

- 在未明确裁决前，AI 应选择保守方案并提出问题，而不是自行假设。

## 规则优先级

当规则之间存在冲突时，遵循以下优先级（高 → 低）：

1. 用户的明确指示
2. 本 AGENTS.md 中的嵌入式强约束
3. 工程目录与层级语义约束
4. 推荐实践

